<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Report</title>
  <link rel="stylesheet" href="/style.css"> <!-- Assuming your CSS is here -->
  <style>
    /* Spinner styles */
    .loader {
      display: none; /* Hidden by default */
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 8px solid #f3f3f3; /* Light gray */
      border-top: 8px solid #3498db; /* Blue */
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      z-index: 1000;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Optional: Overlay to dim the background */
    .loader-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5); /* Semi-transparent gray */
      z-index: 999;
    }
  </style>
</head>
<body>
  <!-- Loader elements -->
  <div class="loader-overlay" id="loaderOverlay"></div>
  <div class="loader" id="loader"></div>

  <!-- Your existing form -->
  <form id="uploadForm" enctype="multipart/form-data">
    <input class="title" type="file" name="report" required/>
    <input type="text" id="clientName" name="clientName" required style="padding: 5px;"/>
    <button type="submit" class="cssbuttons-io-button">
      <svg ...> <!-- Your SVG icon --> </svg>
      <span>Upload</span>
    </button>
  </form>

  <!-- Result div -->
  <div id="result" style="display: none;">
    <p style="color: #fff;">Your Report Is Ready:</p>
    <a id="downloadLink" href="#">
      <button class="cssbuttons-io-buttonn">
        <svg ...> <!-- Your SVG icon --> </svg>
        <span>Download Here</span>
      </button>
    </a>
    <p style="color: #fff;">QR Code:</p>
    <img id="qrCodeImage" src="#" alt="QR Code" />
  </div>

  <script>
    const form = document.getElementById('uploadForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('Form submitted');

      // Show the loader and overlay
      document.getElementById('loader').style.display = 'block';
      document.getElementById('loaderOverlay').style.display = 'block';

      const formData = new FormData(form);
      try {
        console.log('Sending fetch request to: /.netlify/functions/upload');
        const response = await fetch('/.netlify/functions/upload', {
          method: 'POST',
          body: formData,
        });
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);

        const data = await response.json();
        console.log('Response data:', data);

        if (response.ok) {
          console.log('Handling download link:', data.downloadUrl);

          // Create a temporary link for downloading
          const downloadLink = document.createElement('a');
          downloadLink.href = data.downloadUrl;
          downloadLink.download = 'processed-report.pdf';
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);

          // Hide the loader and overlay once download starts
          document.getElementById('loader').style.display = 'none';
          document.getElementById('loaderOverlay').style.display = 'none';

          console.log('Setting QR code image:', data.qrCodeUrl);
          document.getElementById('qrCodeImage').src = data.qrCodeUrl;

          console.log('Showing result div');
          document.getElementById('result').style.display = 'block';

          document.getElementById('downloadLink').textContent = 'Download Complete';
        } else {
          console.error('Server error:', data.error);
          alert('Error: ' + data.error);
          // Hide loader on error
          document.getElementById('loader').style.display = 'none';
          document.getElementById('loaderOverlay').style.display = 'none';
        }
      } catch (err) {
        console.error('Fetch error:', err);
        alert('Error during upload: ' + err.message);
        // Hide loader on error
        document.getElementById('loader').style.display = 'none';
        document.getElementById('loaderOverlay').style.display = 'none';
      }
    });
  </script>
</body>
</html>